<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Time-Curve Betting Simulation</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.58.1/build/stlite.css" />
  </head>
  <body>
    <div id="root">
      <div style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; font-family: sans-serif; color: #333;">
        <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #0071e3; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px;"></div>
        <div>Loading Simulation...</div>
        <div style="font-size: 0.8em; color: #666; margin-top: 10px;">Initializing Python Runtime (this may take a minute)</div>
      </div>
      <style>
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
      </style>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.58.1/build/stlite.js"></script>
    <script>
      window.onerror = function(message, source, lineno, colno, error) {
        const root = document.getElementById("root");
        root.innerHTML += '<div style="color: red; padding: 20px; background: #xffdddd; border: 1px solid red; margin: 20px; white-space: pre-wrap;"><h3>Error:</h3>' + message + '\n' + source + ':' + lineno + '</div>';
      };
      window.onunhandledrejection = function(event) {
        const root = document.getElementById("root");
        root.innerHTML += '<div style="color: red; padding: 20px; background: #xffdddd; border: 1px solid red; margin: 20px; white-space: pre-wrap;"><h3>Unhandled Rejection:</h3>' + event.reason + '</div>';
      };

      try {
        stlite.mount({
          requirements: ["streamlit"],
          entrypoint: "app.py",
          files: {
            "app.py": `
import streamlit as st
import random
import math

# --- Configuration ---
st.set_page_config(page_title="Time-Curve Betting Simulation", layout="wide")

# --- Core Logic ---

def calculate_multiplier(t, k, side='Favorite', T_max=90):
    if t < 0: return 1.0
    
    if side == 'Favorite':
        if t > T_max: return 0.0
        return 1.0 - (t / T_max) ** k
    else: # Underdog Bonus
        return 1.0 + (t / T_max) ** k

def calculate_shares(amount, side, t, k, T_max=90):
    multiplier = calculate_multiplier(t, k, side, T_max)
    return amount * multiplier

# --- Agent Simulation ---

class Agent:
    def __init__(self, name, strategy_type):
        self.name = name
        self.strategy_type = strategy_type
        self.bet_amount = 100.0
        self.bet_time = 0
        self.side = 'Favorite'
        self.shares = 0.0

def run_simulation(k_factor, win_prob, winner_side, num_agents=100):
    agents = []
    
    num_believers = int(num_agents * 0.4)
    num_snipers = int(num_agents * 0.2)
    num_degens = int(num_agents * 0.4)
    
    # Create Agents
    for i in range(num_believers):
        agent = Agent(f"Believer_{i}", "Believer")
        agent.side = 'Favorite'
        agent.bet_time = random.randint(0, 20)
        agents.append(agent)
        
    for i in range(num_snipers):
        agent = Agent(f"Sniper_{i}", "Sniper")
        agent.side = 'Favorite'
        agent.bet_time = random.randint(80, 90)
        agents.append(agent)
        
    for i in range(num_degens):
        agent = Agent(f"Degen_{i}", "Degen")
        agent.side = 'Underdog'
        agent.bet_time = random.randint(0, 90)
        agents.append(agent)
    
    # Process Bets
    pool_favorite = 0.0
    pool_underdog = 0.0
    total_shares_favorite = 0.0
    total_shares_underdog = 0.0
    
    results = []
    
    for agent in agents:
        agent.shares = calculate_shares(agent.bet_amount, agent.side, agent.bet_time, k_factor)
        
        if agent.side == 'Favorite':
            pool_favorite += agent.bet_amount
            total_shares_favorite += agent.shares
        else:
            pool_underdog += agent.bet_amount
            total_shares_underdog += agent.shares
            
        results.append({
            "Agent Type": agent.strategy_type,
            "Bet Time (min)": agent.bet_time,
            "Side": agent.side,
            "Bet Amount": agent.bet_amount,
            "Shares Received": agent.shares,
            "Multiplier": calculate_multiplier(agent.bet_time, k_factor, agent.side)
        })
        
    total_pot = pool_favorite + pool_underdog
    
    if winner_side == 'Favorite':
        winning_shares = total_shares_favorite
    else:
        winning_shares = total_shares_underdog
        
    if winning_shares > 0:
        payout_per_share = total_pot / winning_shares
    else:
        payout_per_share = 0
        
    # Calculate Payouts and ROI
    sniper_rois = []
    
    for res in results:
        if res['Side'] == winner_side:
            res['Payout'] = res['Shares Received'] * payout_per_share
        else:
            res['Payout'] = 0.0
            
        res['ROI %'] = (res['Payout'] - res['Bet Amount']) / res['Bet Amount'] * 100
        
        if res['Agent Type'] == 'Sniper':
            sniper_rois.append(res['ROI %'])
            
    avg_sniper_roi = sum(sniper_rois) / len(sniper_rois) if sniper_rois else 0.0
    
    return results, pool_favorite, pool_underdog, total_pot, avg_sniper_roi

# --- Apple Style Assets ---

def inject_custom_css():
    st.markdown("""
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        html, body, [class*="css"] {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .stApp {
            background: radial-gradient(circle at 50% 0%, #ffffff 0%, #f5f5f7 100%);
            color: #1D1D1F;
        }
        h1, h2, h3 { color: #1D1D1F !important; font-weight: 600 !important; letter-spacing: -0.02em; }
        div[data-testid="stExpander"], div[data-testid="stMetric"] {
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.04);
            padding: 20px;
        }
        .stButton > button {
            background: linear-gradient(180deg, #0071E3 0%, #0077ED 100%);
            color: #FFFFFF;
            border: none;
            border-radius: 980px;
            font-weight: 500;
            padding: 0.6rem 1.2rem;
            box-shadow: 0 2px 5px rgba(0, 113, 227, 0.2);
        }
        .stButton > button:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(0, 113, 227, 0.4); }
        .stSlider > div > div > div > div { background-color: #0071E3 !important; }
    </style>
    """, unsafe_allow_html=True)

inject_custom_css()

st.title("Time-Curve Simulation (Super Lite)")
st.markdown("Stress-testing the parimutuel market mechanism.")

# --- Sidebar ---
st.sidebar.header("Settings")
with st.sidebar.expander("Parameters", expanded=True):
    k_factor = st.slider("Decay Sharpness (k)", 1.0, 20.0, 5.0, 0.5)

with st.sidebar.expander("Match Context", expanded=True):
    win_prob = st.slider("Win Probability (%)", 0, 100, 80)
    current_time = st.slider("Current Time (min)", 0, 90, 45)
    winner_side = st.radio("Outcome", ["Favorite", "Underdog"])

# --- Section 1: Mechanism Visualization ---
st.header("Mechanism Overview")

col1, col2 = st.columns(2)

# Generate data points manually
t_values = [i for i in range(0, 91)] # 0 to 90
m_fav = [calculate_multiplier(t, k_factor, 'Favorite') for t in t_values]
m_und = [calculate_multiplier(t, k_factor, 'Underdog') for t in t_values]

# Prepare data for st.line_chart (requires dict or dataframe)
# Using dict of lists
chart_data_mult = {
    "Favorite": m_fav,
    "Underdog": m_und
}

with col1:
    st.subheader("Multiplier Curves")
    # st.line_chart(chart_data_mult, color=["#FF9500", "#34C759"])
    st.info("Charts disabled for performance")

with col2:
    st.subheader("Effective Price")
    p_fav = [1/m if m > 0.01 else 100 for m in m_fav]
    p_und = [1/m for m in m_und]
    
    chart_data_price = {
        "Favorite": p_fav,
        "Underdog": p_und
    }
    # st.line_chart(chart_data_price, color=["#FF9500", "#34C759"])
    st.info("Charts disabled for performance")

mult_fav = calculate_multiplier(current_time, k_factor, 'Favorite')
mult_und = calculate_multiplier(current_time, k_factor, 'Underdog')

c1, c2 = st.columns(2)
c1.metric("Favorite Multiplier", f"{mult_fav:.4f}")
c2.metric("Underdog Multiplier", f"{mult_und:.4f}")

# --- Section 2: Agent Simulation ---
st.divider()
st.header("Simulation Arena")

if st.button("Run Simulation", type="primary", use_container_width=True):
    with st.spinner("Processing..."):
        results, pool_fav, pool_und, total_pot, avg_sniper_roi = run_simulation(k_factor, win_prob, winner_side)
        
        # --- Metrics Row ---
        m1, m2, m3, m4 = st.columns(4)
        m1.metric("Total Pool", f"${total_pot:,.0f}")
        m2.metric("Favorite Pool", f"${pool_fav:,.0f}")
        m3.metric("Underdog Pool", f"${pool_und:,.0f}")
        m4.metric("Sniper ROI", f"{avg_sniper_roi:.1f}%")

        # --- Analysis ---
        st.subheader("Simulation Report")
        if winner_side == 'Favorite':
            st.success(f"Favorite Won. Snipers ROI: {avg_sniper_roi:.1f}%.")
        else:
            st.info(f"Underdog Won.")

        st.subheader("Raw Data")
        st.dataframe(results)

`
          }
        });
      } catch (e) {
        const root = document.getElementById("root");
        root.innerHTML += '<div style="color: red; padding: 20px; background: #xffdddd; border: 1px solid red; margin: 20px; white-space: pre-wrap;"><h3>Mount Error:</h3>' + e + '</div>';
      }
    </script>
  </body>
</html>
